# BinaryAnalystAgent

An AI-powered binary analysis agent that leverages IDA Pro for static analysis to identify security vulnerabilities in compiled binaries.

## Overview

BinaryAnalystAgent is a specialized agent within PentestAgent that focuses on automated vulnerability discovery in binaries. It uses IDA Pro as its analysis backend via the Model Context Protocol (MCP), combining static analysis with AI-driven vulnerability pattern recognition.

## Features

- **Automated Vulnerability Detection**: Identifies buffer overflows, format string bugs, command injection, and more
- **IDA Pro Integration**: Full access to IDA's disassembly and analysis capabilities
- **Cross-Platform**: Supports Windows IDA Pro from WSL with automatic path conversion
- **RAG-Enhanced Context**: Uses knowledge base for vulnerability pattern matching
- **Structured Findings**: Saves discoveries with CWE mappings and evidence

## Requirements

- **Python 3.10+**
- **IDA Pro** (version 8.x or 9.x recommended)
- **LLM API Key** (OpenAI, Anthropic, or other LiteLLM-supported provider)

## Installation

BinaryAnalystAgent is included with PentestAgent. No additional installation required.

```bash
# Ensure PentestAgent is installed
pip install -e ".[all]"
```

### IDA Pro Configuration

Set the `IDA_PATH` environment variable to your IDA Pro installation:

```bash
# Linux
export IDA_PATH="/opt/ida/idat64"

# Windows via WSL
export IDA_PATH="/mnt/c/Program Files/IDA Pro 9.0/idat64.exe"

# Or add to .env file
echo 'IDA_PATH=/path/to/idat64' >> .env
```

## Usage

### Command Line

```bash
# Basic analysis
pentestagent analyze ./vulnerable_binary

# Custom analysis task
pentestagent analyze ./binary --task "Find all uses of strcpy and trace their data sources"

# Generate report after analysis
pentestagent analyze ./binary --report --output ./reports/

# Set maximum iterations
pentestagent analyze ./binary --max-iterations 20
```

### CLI Options

| Option | Description |
|--------|-------------|
| `<binary>` | Path to the binary file to analyze (required) |
| `--task` | Custom analysis task description |
| `--report` | Generate a markdown report after analysis |
| `--output` | Output directory for reports (default: `loot/reports/`) |
| `--max-iterations` | Maximum agent iterations (default: 30) |

### Default Analysis Task

If no `--task` is specified, the agent uses:

> "Analyze this binary for security vulnerabilities. Focus on buffer overflows, format string bugs, and other memory corruption issues."

## IDA Pro Tools

The agent has access to these IDA-powered tools via MCP:

| Tool | Description |
|------|-------------|
| `load_binary` | Load a binary into IDA for analysis. Must be called first. |
| `get_functions` | List all functions with metadata (address, size, flags) |
| `disassemble_function` | Get assembly with dangerous call detection |
| `get_strings` | Extract strings (identifies format strings and paths) |
| `find_xrefs` | Find cross-references to/from addresses or symbols |

### Example Tool Output

```json
{
  "success": true,
  "data": {
    "function_name": "vulnerable",
    "start_address": "0x401156",
    "size": 64,
    "dangerous_calls": [
      {
        "address": "0x401180",
        "function": "strcpy",
        "context": "call    _strcpy"
      }
    ]
  }
}
```

## Vulnerability Focus

The agent is trained to identify:

### Memory Corruption
- **Buffer Overflows**: Stack/heap overflows from `strcpy`, `strcat`, `sprintf`, `gets`, `scanf`
- **Format String Vulnerabilities**: `printf`/`sprintf` with user-controlled format strings
- **Integer Overflows**: Arithmetic operations leading to unexpected values
- **Use-After-Free**: Memory accessed after deallocation

### Code Execution
- **Command Injection**: `system()`, `exec()`, `popen()` with controllable arguments
- **Arbitrary Write**: Writing to attacker-controlled addresses

### Information Disclosure
- **Hardcoded Secrets**: API keys, passwords in strings
- **Debug Information**: Leftover debugging symbols

## Analysis Workflow

1. **Load Binary**: Agent loads the binary into IDA Pro
2. **Plan Generation**: Creates a step-by-step analysis plan
3. **Function Enumeration**: Lists all functions, focusing on non-library code
4. **String Analysis**: Extracts and categorizes strings
5. **Dangerous Pattern Detection**: Identifies calls to unsafe functions
6. **Data Flow Analysis**: Traces user input to dangerous sinks
7. **Finding Documentation**: Saves vulnerabilities with evidence

## Output

### Notes

Findings are saved to `loot/notes.json` with categories:

```json
{
  "bof_vulnerable_func": {
    "content": "Buffer overflow in vulnerable() at 0x401234 - strcpy with unbounded input",
    "category": "vulnerability",
    "target": "/path/to/binary",
    "weaknesses": [
      {"id": "CWE-120", "description": "Buffer Copy without Checking Size of Input"}
    ]
  }
}
```

### Reports

When `--report` is specified, generates markdown reports in `loot/reports/`.

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `IDA_PATH` | Path to IDA Pro executable | Auto-detect |
| `IDA_MCP_DEBUG` | Enable debug output (`1`/`true`) | `false` |
| `PENTESTAGENT_MODEL` | LLM model to use | `claude-sonnet-4-20250514` |
| `PENTESTAGENT_AGENT_MAX_ITERATIONS` | Max agent iterations | `30` |

## Testing the IDA Integration

Run the self-test to verify IDA Pro connectivity:

```bash
# Test with a sample binary
python third_party/ida_mcp/ida_server.py --self-test ./test_binary

# With specific IDA path
python third_party/ida_mcp/ida_server.py --self-test ./test_binary --ida-path /path/to/idat64
```

## Troubleshooting

### IDA Pro Not Found

```
Error: IDA Pro not found. Set IDA_PATH environment variable.
```

**Solution**: Set `IDA_PATH` to point to `idat64` (Linux) or `idat64.exe` (Windows).

### WSL Path Issues

When using Windows IDA from WSL, ensure:
- The binary path is accessible from Windows (e.g., `/mnt/c/...`)
- Or the binary is in a location IDA can access via `\\wsl$\Ubuntu\...`

### Timeout Errors

```
Error: IDA analysis timed out after 300s
```

**Solution**: Large binaries take longer. The timeout is 5 minutes by default. For very large binaries, consider analyzing specific functions rather than the entire binary.

### MCP Connection Issues

Ensure the MCP server is configured in `pentestagent/mcp/mcp_servers.json`:

```json
{
  "mcpServers": {
    "ida-local": {
      "command": "python3",
      "args": ["third_party/ida_mcp/ida_server.py", "--transport", "stdio"],
      "description": "IDA Pro binary analysis",
      "enabled": true
    }
  }
}
```

## Architecture

```
pentestagent analyze ./binary
       │
       ▼
┌─────────────────────────────┐
│    BinaryAnalystAgent       │
│  (LLM-powered reasoning)    │
└─────────────────────────────┘
       │
       ▼ MCP Protocol
┌─────────────────────────────┐
│      IDA MCP Server         │
│  (third_party/ida_mcp/)     │
└─────────────────────────────┘
       │
       ▼ Batch Mode
┌─────────────────────────────┐
│        IDA Pro              │
│   (IDAPython scripts)       │
└─────────────────────────────┘
```

## Example Session

```bash
$ pentestagent analyze ./vuln_example --report

[*] Loading binary: ./vuln_example
[*] IDA Pro analysis complete
[*] Binary: ELF64, 15 functions

[Agent] Planning analysis...
  1. Load binary and gather metadata
  2. Enumerate functions and identify interesting targets
  3. Analyze string references for format string patterns
  4. Disassemble functions calling dangerous APIs
  5. Trace data flow from input sources
  6. Document findings with CWE mappings

[Agent] Executing step 1...
[IDA MCP] Tool: load_binary(./vuln_example)
  File Type: ELF for x86_64
  Functions: 15
  Entry: 0x401080

[Agent] Executing step 4...
[IDA MCP] Tool: disassemble_function(vulnerable)
  DANGEROUS CALLS in vulnerable:
    0x401180: call _strcpy
    0x4011a0: call _printf

[Agent] Found: Buffer overflow in vulnerable() - strcpy with user input
[Agent] Found: Potential format string in vulnerable() - printf call

[*] Analysis complete. 2 vulnerabilities found.
[*] Report saved to: loot/reports/vuln_example_20240115.md
```

## License

MIT - Same as PentestAgent
